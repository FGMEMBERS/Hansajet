<?xml version="1.0"?>
<!--
  Flight Control Computer, Sperry 1781218-50
  Modeled after HFB 320 Hansa Jet Operations Manual, Section 9.1.2
  Functions and items not marked with a reference to the manual
  are pure imagination or trial-and-error

  (c) Torsten Dreyer - Torsten@no-spam-t3r.de (ignore no-spam-)
  
  History:
  2009-11-28 initial work 
-->
<!--
  Quote from HFB 320 Operations Manual:
9.0
  The Sperry SP-40 autopilot provides three axis control of the airplane.
  Upon pilot's command the autopilot will perform the following maneuvers
  a) Coordinated turn
  b) Pitch trim
  c) Fly to preselected heading
  d) Maintain constant altitude
  e) Fly on VOR radials and ILS beams

9.3
  The autopilot will maintain the pitch attitude existing at the time of engagement. 
  Interlocks allow the system to be engaged at bank angles up to 6 degrees, thereby 
  relieving to trim the airplane accurately before engagement.
  Bank angle limited to 30 degrees
-->
<PropertyList>

  <!--  Monitor current magnetic heading for heading-hold -->
  <filter>
    <name>AP:MagHeading Monitor</name>
    <debug>false</debug>
    <enable>
      <condition>
        <equals>
          <property>autopilot/locks/heading</property>
          <value/>
        </equals>
      </condition>
    </enable>
    <type>gain</type>
    <input>orientation/heading-magnetic-deg</input>
    <output>autopilot/settings/target-heading-deg</output>
    <gain>1.0</gain>
  </filter>

  <!-- ===================================================== -->
  <!-- =================== PITCH AXIS ====================== -->
  <!-- ===================================================== -->
  <!--  Monitor current pitch for pitch-hold -->
  <filter>
    <name>AP:Pitch Monitor</name>
    <debug>false</debug>
    <enable>
      <condition>
        <equals>
          <property>autopilot/locks/altitude</property>
          <value/>
        </equals>
      </condition>
    </enable>
    <type>gain</type>
    <input>orientation/pitch-deg</input>
    <output>autopilot/settings/target-pitch-deg</output>
    <gain>1.0</gain>
  </filter>

  <!--  Monitor current static pressure for altitude-hold -->
  <filter>
    <name>AP:Static Pressure Monitor</name>
    <debug>false</debug>
    <enable>
      <condition>
        <not-equals>
          <property>autopilot/locks/altitude</property>
          <value>altitude-hold</value>
        </not-equals>
      </condition>
    </enable>
    <type>gain</type>
<!--
    <input>systems/static[0]/pressure-inhg</input>
    <output>autopilot/settings/target-pressure-inhg</output>
-->
    <input>instrumentation/altimeter[0]/pressure-alt-ft</input>
    <output>autopilot/settings/target-altitude-ft</output>
    <gain>1.0</gain>
  </filter>


  <pid-controller>
    <name>AP:Pitch Hold</name>
    <debug>false</debug>
    <enable>
      <condition>
        <and>
          <property>instrumentation/sp40/afc-engaged</property>
          <or>
          <equals>
            <property>autopilot/locks/altitude</property>
            <value>pitch-hold</value>
          </equals>
          <equals>
            <property>autopilot/locks/altitude</property>
            <value>altitude-hold</value>
          </equals>
          </or>
        </and>
      </condition>
    </enable>
    <input>orientation/pitch-deg</input>
    <reference>autopilot/settings/target-pitch-deg</reference>
    <output>autopilot/internal/elevator-command</output>
    <config>
      <Kp>-0.03</Kp>
      <beta>1.0</beta> 
      <alpha>0.1</alpha>
      <gamma>0.0</gamma>
      <Ti>7.5</Ti>
      <Td>0.0</Td>
      <u_min>-1.0</u_min>
      <u_max>1.0</u_max>
    </config>
  </pid-controller>

  <pid-controller>
    <name>AP:Altitude Hold</name>
    <debug>false</debug>
    <enable>
      <condition>
        <and>
          <property>instrumentation/sp40/afc-engaged</property>
          <equals>
            <property>autopilot/locks/altitude</property>
            <value>altitude-hold</value>
          </equals>
        </and>
      </condition>
    </enable>
    <input>instrumentation/altimeter[0]/pressure-alt-ft</input>
    <reference>autopilot/settings/target-altitude-ft</reference>
    <output>autopilot/settings/target-pitch-deg</output>
    <config>
      <Kp>0.02</Kp>
      <beta>1.0</beta> 
      <alpha>0.1</alpha>
      <gamma>0.0</gamma>
      <Ti>15</Ti>
      <Td>0.0050</Td>
      <u_min>-5.0</u_min>
      <u_max>15.0</u_max>
    </config>
  </pid-controller>

  <!-- ===================================================== -->
  <!-- =================== ROLL  AXIS ====================== -->
  <!-- ===================================================== -->
  <!--  first stage: Compute heading offset -->
  <!--  output is in the range -180 .. +180 degree -->
  <pi-simple-controller>
    <name>AP:Heading Offset Computer</name>
    <debug>false</debug>
    <input>
      <property>orientation/heading-magnetic-deg</property>
    </input>
    <reference>
      <property>autopilot/settings/target-heading-deg</property>
    </reference>
    <output>autopilot/internal/heading-offset-deg</output>
    <config> <!-- just build the delta, no integration -->
      <Kp>1.0</Kp>
      <Ki>0.0</Ki>
    </config>
    <period>
      <min>-180</min>
      <max>180</max>
    </period>
  </pi-simple-controller>

  <!--  second stage: compute target roll based on heading offset
        rule of thumb: start level off at half bank angle
        opposite rule of thumb: bank angle is twice the heading offset
  -->
  <filter>
    <name>AP:Target Roll Computer</name>
    <debug>false</debug>
    <type>gain</type>
    <input>autopilot/internal/heading-offset-deg</input>
    <output>autopilot/settings/target-roll-deg</output>
    <gain>2.0</gain>
    <u_min>-30.0</u_min>
    <u_max>30.0</u_max>
  </filter>


  <!--  second stage: compute the aileron command
        for the target roll
    -->
  <pid-controller>
    <name>AP:Roll Hold</name>
    <debug>false</debug>
    <enable>
      <condition>
        <and>
          <property>instrumentation/sp40/afc-engaged</property>
          <equals>
            <property>autopilot/locks/heading</property>
            <value>true-heading-hold</value>
            <!-- <value>dg-heading-hold</value> -->
            <!-- <value>nav1-hold</value> -->
          </equals>
        </and>
      </condition>
    </enable>
    <input>orientation/roll-deg</input>
    <reference>autopilot/settings/target-roll-deg</reference>
    <output>autopilot/internal/aileron-command</output>
    <config>
      <Kp>0.010</Kp>
      <beta>1.0</beta>
      <alpha>0.1</alpha>
      <gamma>0.0</gamma>
      <Ti>10</Ti>
      <Td>0.0</Td>
      <u_min>-1.0</u_min>
      <u_max>1.0</u_max>
    </config>
  </pid-controller>

  <!-- ========================================================================== -->
  <!-- Server Driver - Pass output commands thru a noise spike filter to avoid    -->
  <!-- rapid control inputs and simulate slow movement o the servos               -->
  <!-- Disable servos in passive-mode                                             -->
  <!-- ========================================================================== -->
  <filter>
    <name>SERVO-DRIVER:aileron</name>
    <debug>false</debug>
    <feedback-if-disabled>true</feedback-if-disabled>
    <enable>
      <condition>
        <!-- enable aileron servo if any heading mode is locked -->
        <property>instrumentation/sp40/afc-engaged</property>
        <not>
          <property>/autopilot/locks/passive-mode</property>
        </not>
        <not-equals>
          <property>/autopilot/locks/heading</property>
          <value/>
        </not-equals>
      </condition>
    </enable>
    <input>/autopilot/internal/aileron-command</input>
    <output>/controls/flight/aileron</output>
    <type>noise-spike</type>
    <max-rate-of-change>0.5</max-rate-of-change>
  </filter>

  <filter>
    <name>SERVO-DRIVER:elevator</name>
    <debug>false</debug>
    <feedback-if-disabled>true</feedback-if-disabled>
    <enable>
      <condition>
        <!-- enable aileron servo if any altitude mode is locked -->
        <property>instrumentation/sp40/afc-engaged</property>
        <not>
          <property>/autopilot/locks/passive-mode</property>
        </not>
        <not-equals>
          <property>/autopilot/locks/altitude</property>
          <value/>
        </not-equals>
      </condition>
    </enable>
    <input>/autopilot/internal/elevator-command</input>
    <output>/controls/flight/elevator</output>
    <type>noise-spike</type>
    <max-rate-of-change>0.2</max-rate-of-change>
  </filter>

  <filter>
    <name>SERVO-DRIVER:rudder</name>
    <debug>false</debug>
    <feedback-if-disabled>true</feedback-if-disabled>
    <enable>
      <condition>
        <property>/instrumentation/autopilot/yaw-damper</property>
      </condition>
    </enable>
    <input>/autopilot/internal/rudder-command</input>
    <output>/controls/flight/rudder-trim</output>
    <type>noise-spike</type>
    <max-rate-of-change>0.10</max-rate-of-change>
  </filter>

</PropertyList>
