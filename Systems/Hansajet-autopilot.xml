<?xml version="1.0"?>

<PropertyList xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../Docs/XMLSchema/autopilot.xsd">
  <!-- ========================================================================== -->
  <!-- 
    HFB 320 Hansa Jet Flight Director/Autopilot digital filter configuration
    
    Based on the only document found on the net for a Sperry Flight Director: 
    NTSB Aircraft Accident Report NTSB-AAR-74-3 (AAR74-03.pdf)
    
    If you have a better document describing the autopilot/flightdirector, please contact the author
    Torsten Dreyer - Torsten (at) t3r (dot) de
  -->
  <!-- ========================================================================== -->
  <!-- 
    Flight Director Modes
    ============
vh  SB    Standby   
    No indication, vertical and horizontal bars are moved out of sight
    
vh  BL   Blue Left
    No pitch/altitude indication, horziontal bar moved out of sight.
    Vertical bar shows course correction commands
    Used for backcourse ILS approaches
    
vh  FI    Flight Instruments
    Vertical bar shows roll command to the heading of the heading bug
    Horziontal bar shows pitch command if altitude-hold is engaged
        
    VOR/LOC
    Vertical and Horizontal bars show FI mode commands if outside "reception cone"
    And course correction commands uppon reception of valid VOR/LOC/GS signals.
    Valid VOR/LOC signal is deflection less than half left/half right
    Valid GS signal is: approaching from below and less than two dots below
    
v   APP
    Show raw data course correction commands
    
vh  GA    Go Around
    Horziontal Bar shows commands fixed pitch up, Vertical Bar commands wings level 
    
    
    Autopilot Modes
    ==========
    Engage
ok  Off    Servos disconnected, flightdirector indication only only
ok  On     Servos connected
    
    Altitude Hold
    Off     No pitch/altitude processing
    On      Maintain pressure altitude as of the time of engagement of Alt Hold
    
    Mach Hold
    Off     No throttle/speed processing
    On      Maintain indicated mach as of the time of engagement of Mach Hold
    
    Head
ok  Hold    Maintain heading of the heading bug
ok  NAV     keep CDI of HSI centered
ok  (LEFT)  perform TURN operation (see Turn)
    
    Turn
ok  Left    perform standad rate (4min) turn to the left
ok  Off     perform wing-level
ok  Right   perform standard rate (4min) turn to the right
    
  -->
<!-- ====================================================================== -->
<!-- =============== Flight Director ====================================== -->
<!-- ====================================================================== -->
<!-- =============== Vertical Needle / Roll Axis ========================== -->
<!-- ====================================================================== -->
  <pi-simple-controller>
    <!-- compute vertical needle deflection based on roll -->
    <name>FD:Roll Command Computer</name>
    <debug>false</debug>
    <enable>
      <condition>
        <or>
          <equals>
            <property>/autopilot/flightdirector/mode</property>
            <value>FI</value>
          </equals>
          <equals>
            <property>/autopilot/flightdirector/mode</property>
            <value>G/A</value>
          </equals>
        </or>
      </condition>
    </enable>
    <input>/orientation/roll-deg</input>
    <reference>
      <!-- FI: follow heading bug -->
      <condition>
        <equals>
          <property>/autopilot/flightdirector/mode</property>
          <value>FI</value>
        </equals>
      </condition>
      <!-- 
        reference is heading-bug-error. Suggest max. bank angle
        of 25deg at 12.5deg offset or more 
      -->
      <property>/autopilot/internal/heading-bug-error-deg</property>
      <scale>2.0</scale>
      <min>-25</min>
      <max>25</max>
    </reference>
    <reference>
      <!-- G/A: wings level, roll shall be zero -->
      <!-- reference is zero -->
      <value>0.0</value>
    </reference>
    <!-- provide input for the needle low pass filter -->
    <output>/autopilot/flightdirector/vertical-deflection-norm</output>
    <config>
      <!-- normalize and clamp [-25..+25] to [-1..+1] -->
      <Kp>0.04</Kp>
      <min>-1.0</min>
      <max>1.0</max>
    </config>
  </pi-simple-controller>

  <filter>
    <!-- compute vertical needle deflection based on nav raw data -->
    <name>FD:LOC Computer</name>
    <type>gain</type>
    <debug>false</debug>
    <enable>
      <condition>
        <or>
          <equals>
            <property>/autopilot/flightdirector/mode</property>
            <value>APP</value>
          </equals>
          <equals>
            <property>/autopilot/flightdirector/mode</property>
            <value>BL</value>
          </equals>
        </or>
      </condition>
    </enable>
    <input>/instrumentation/nav/heading-needle-deflection</input>
    <gain>
      <!-- APP: front course. Present raw data -->
      <condition>
        <equals>
          <property>/autopilot/flightdirector/mode</property>
          <value>APP</value>
        </equals>
      </condition>
      <value>0.1</value>
    </gain>
    <gain>
      <!-- BL: back course. Present inverted raw data -->
      <value>-0.1</value>
    </gain>
    <!-- provide input for the needle low pass filter -->
    <output>/autopilot/flightdirector/vertical-deflection-norm</output>
  </filter>

<!-- ====================================================================== -->
<!-- =============== Horizontal Needle / Pitch Axis ======================= -->
<!-- ====================================================================== -->

  <!-- ===================================================== -->
  <!-- FI: Flight Instruments, pitch to hold altitude        -->
  <!-- pitch and roc/rod limited by properties               -->
  <!-- ===================================================== -->

  <!-- copy pressure altitude to target altitude if alt-hold switch is off -->
  <filter>
    <name>FD:Target Altitude Monitor</name>
    <debug>false</debug>
    <enable>
      <condition>
        <not>
          <property>/autopilot/flightdirector/altitude-hold</property>
        </not>
      </condition>
    </enable>
    <type>gain</type>
    <input>instrumentation/altimeter/pressure-alt-ft</input>
    <output>autopilot/settings/target-altitude-ft</output>
    <gain>1.0</gain>
  </filter>

  <!-- compute rate of climb base on altitude offset -->
  <pi-simple-controller>
    <name>FD:Altitude Hold ROC Computer</name>
    <debug>false</debug>
    <input>/instrumentation/altimeter/pressure-alt-ft</input>
    <reference>/autopilot/settings/target-altitude-ft</reference>
    <output>/autopilot/settings/vertical-speed-fpm</output>
    <config>
      <Kp>2.0</Kp> <!-- climb 1000fpm for each 500ft off -->
      <Td>120</Td>
      <min>/autopilot/settings/max-rod-fpm</min>
      <max>/autopilot/settings/max-roc-fpm</max>
    </config>
  </pi-simple-controller>

  <!-- compute pitch based on climb speed offset -->
  <pid-controller>
    <name>FD:Altitude Hold Pitch Computer</name>
    <debug>false</debug>
    <input>
      <property>/velocities/vertical-speed-fps</property>
      <scale>60</scale>
    </input>
    <reference>/autopilot/settings/vertical-speed-fpm</reference>
    <output>/autopilot/settings/target-pitch-deg</output>
    <config>
      <Kp>0.002</Kp> 
      <beta>1.0</beta>
      <alpha>0.1</alpha>
      <gamma>1.0</gamma>
      <Ti>1.0</Ti>
      <Td>1e-12</Td>
      <min>/autopilot/settings/min-pitch-deg</min>
      <max>/autopilot/settings/max-pitch-deg</max>
    </config>
  </pid-controller>

  <pi-simple-controller>
    <!-- compute vertical needle deflection based on roll -->
    <name>FD:Pitch Command Computer</name>
    <debug>false</debug>
    <enable>
      <condition>
        <or>
          <equals>
            <property>/autopilot/flightdirector/mode</property>
            <value>FI</value>
          </equals>
          <equals>
            <property>/autopilot/flightdirector/mode</property>
            <value>G/A</value>
          </equals>
        </or>
      </condition>
    </enable>
    <input>/orientation/pitch-deg</input>

    <!-- FI and altitude-hold: follow target computed pitch -->
    <reference>
      <condition>
        <equals>
          <property>/autopilot/flightdirector/mode</property>
          <value>FI</value>
        </equals>
        <property>/autopilot/flightdirector/altitude-hold</property>
      </condition>
      <property>/autopilot/settings/target-pitch-deg</property>
    </reference>

    <!-- FI and not altitude-hold: move out of sight -->
    <reference>
      <condition>
        <equals>
          <property>/autopilot/flightdirector/mode</property>
          <value>FI</value>
        </equals>
        <not>
          <property>/autopilot/flightdirector/altitude-hold</property>
        </not>
      </condition>
      <value>90</value>
    </reference>

    <!-- else mode is G/A, fixed pitch up -->
    <reference>/autopilot/settings/go-around-pitch-deg</reference>
    <!-- provide input for the needle low pass filter -->
    <output>/autopilot/flightdirector/horizon-deflection-norm</output>
    <config>
      <!-- normalize [-40..+40] to [-1..+1] -->
      <Kp>0.025</Kp>
    </config>
  </pi-simple-controller>


  <filter>
    <!-- compute horizontal needle deflection based on nav raw data -->
    <name>FD:GS Computer</name>
    <type>gain</type>
    <debug>false</debug>
    <enable>
      <condition>
        <equals>
          <property>/autopilot/flightdirector/mode</property>
          <value>APP</value>
        </equals>
      </condition>
    </enable>
    <input>/instrumentation/nav/gs-needle-deflection</input>
    <gain>0.1</gain>
    <!-- provide input for the needle low pass filter -->
    <output>/autopilot/flightdirector/horizon-deflection-norm</output>
  </filter>

<!-- ====================================================================== -->
<!-- =============== Needle Driver Filter ================================= -->
<!-- ====================================================================== -->
  <!-- low pass output filter for the horizontal bar -->
  <filter>
    <name>FD:horizontal bar deflection filter</name>
    <debug>false</debug>
    <type>exponential</type>
    <input>
      <condition>
        <!-- move out of sight -->
        <or>
          <equals>
            <property>/autopilot/flightdirector/mode</property>
            <value>SB</value>
          </equals>
          <equals>
            <property>/autopilot/flightdirector/mode</property>
            <value>BL</value>
          </equals>
        </or>
      </condition>
      <value>1.2</value>
    </input>
    <input>
      <property>/autopilot/flightdirector/horizon-deflection-norm</property>
      <value>0.0</value>
    </input>
    <output>/instrumentation/attitude-indicator[0]/horizon-deflection-norm</output>
    <output>/instrumentation/attitude-indicator[1]/horizon-deflection-norm</output>
    <filter-time>0.3</filter-time>
  </filter>
  <!-- =========================================== -->
  <!-- low pass output filter for the vertical bar -->
  <filter>
    <name>FD:vertical bar deflection filter</name>
    <debug>false</debug>
    <type>exponential</type>
    <input>
      <condition>
        <!-- move out of sight -->
        <equals>
          <property>/autopilot/flightdirector/mode</property>
          <value>SB</value>
        </equals>
      </condition>
      <value>1.2</value>
    </input>
    <input>
      <property>/autopilot/flightdirector/vertical-deflection-norm</property>
      <value>0.0</value>
    </input>
    <output>/instrumentation/attitude-indicator[0]/vertical-deflection-norm</output>
    <output>/instrumentation/attitude-indicator[1]/vertical-deflection-norm</output>
    <filter-time>0.3</filter-time>
  </filter>

<!-- ====================================================================== -->
<!-- =============== Auto Pilot =========================================== -->
<!-- ====================================================================== -->
<!-- =============== Roll Axis ============================================ -->
<!-- ====================================================================== -->

  <!-- Wing leveler --> 
  <pid-controller>
    <name>AP:Wing Leveler</name>
    <debug>false</debug>
    <enable>
      <condition>
        <not>
          <property>/autopilot/locks/passive-mode</property>
        </not>
        <equals>
          <property>/autopilot/locks/heading</property>
          <value>wing-leveler</value>
        </equals>
      </condition>
    </enable>
    <input>/orientation/yaw-rate-degps</input>
    <reference>
      <property>/autopilot/controls/turn</property>
      <scale>/autopilot/settings/standard-turn-rate-degps</scale>
    </reference>
    <output>/autopilot/internal/aileron-command</output>
    <config>
      <Kp>0.03</Kp>
      <beta>1.0</beta>
      <alpha>0.1</alpha>
      <gamma>0.0</gamma>
      <Ti>5.0</Ti>
      <Td>0.06000</Td>
      <min>-0.5</min>
      <max>0.5</max>
    </config>
  </pid-controller>

  <!-- NAV/HDG HOLD --> 

  <!-- filter the cdi input -->
  <filter>
    <name>AP:CDI Filter</name>
    <debug>false</debug>
    <input>
      <property>/instrumentation/nav[0]/heading-needle-deflection</property>
      <scale>0.1</scale>
    </input>
    <output>/autopilot/internal/course-deviation-norm</output>
    <filter-time>/autopilot/settings/cdi-filter-time</filter-time>
  </filter>

  <pi-simple-controller>
    <name>AP:NAV/Heading Hold</name>
    <debug>false</debug>
    <enable>
      <condition>
        <not>
          <property>/autopilot/locks/passive-mode</property>
        </not>
        <or>
          <equals>
            <property>/autopilot/locks/heading</property>
            <value>dg-heading-hold</value>
          </equals>
          <equals>
            <property>/autopilot/locks/heading</property>
            <value>nav1-hold</value>
          </equals>
        </or>
      </condition>
    </enable>
    <input>/orientation/roll-deg</input>
    <reference>
      <!-- NAV Mode -->
      <condition>
        <equals>
          <property>/autopilot/locks/heading</property>
          <value>nav1-hold</value>
        </equals>
      </condition>
      <property>/instrumentation/heading-indicator[0]/course-error-deg</property>
      <scale>2.0</scale>
      <offset>
        <property>/autopilot/internal/course-deviation-norm</property>
        <scale>/autopilot/settings/nav-intercept-angle-deg2</scale> 
      </offset>
      <min>-25</min>
      <max>25</max>
    </reference>
    <reference>
      <!-- HDG Mode -->
      <property>/autopilot/internal/heading-bug-error-deg</property>
      <scale>2.0</scale>
      <min>-25</min>
      <max>25</max>
    </reference>
    <output>
      <prop>/autopilot/internal/aileron-command</prop>
    </output>
    <config> 
      <Kp>0.012</Kp>
      <Ti>25</Ti>
      <min>-0.3</min>
      <max>0.3</max>
    </config>
  </pi-simple-controller>

<!-- ====================================================================== -->
<!-- =============== Pitch Axis =========================================== -->
<!-- ====================================================================== -->

  <pid-controller>
    <name>AP:Pitch Hold</name>
    <debug>true</debug>
    <enable>
      <condition>
        <equals>
          <property>/autopilot/locks/altitude</property>
          <value>altitude-hold</value>
        </equals>
      </condition>
    </enable>
    <input>/orientation/pitch-deg</input>
    <reference>autopilot/settings/target-pitch-deg</reference>
    <output>/autopilot/internal/elevator-command</output>
    <config>
      <Kp>-0.05</Kp>
      <beta>1.0</beta>
      <alpha>0.1</alpha>
      <gamma>0.0</gamma>
      <Ti>10.0</Ti>
      <Td>0.0</Td>
      <u_min>-0.50</u_min>
      <u_max>0.50</u_max>
    </config>
  </pid-controller>

<!-- ====================================================================== -->
<!-- =============== Yaw Axis ============================================= -->
<!-- ====================================================================== -->
  <!-- Yaw Damper, automatic ball kicker -->
  <pid-controller>
    <name>AP:Yaw Damper</name>
    <debug>false</debug>
    <enable>
      <condition>
        <property>/instrumentation/autopilot/yaw-damper</property>
      </condition>
    </enable>
    <input>/instrumentation/slip-skid-ball/indicated-slip-skid</input>
    <reference>0.0</reference>
    <output>/autopilot/internal/rudder-command</output>
    <config>
      <Kp>5</Kp>
      <beta>1.0</beta>
      <alpha>0.1</alpha>
      <gamma>0.0</gamma>
      <Ti>45.0</Ti>
      <Td>0.0</Td>
      <u_min>-0.15</u_min>
      <u_max>0.15</u_max>
    </config>
  </pid-controller>

  <!-- ========================================================================== -->
  <!-- Server Driver - Pass output commands thru a noise spike filter to avoid    -->
  <!-- rapid control inputs and simulate slow movement o the servos               -->
  <!-- Disable servos in passive-mode                                             -->
  <!-- ========================================================================== -->
  <filter>
    <name>SERVO-DRIVER:aileron</name>
    <debug>false</debug>
    <feedback-if-disabled>true</feedback-if-disabled>
    <enable>
      <condition>
        <!-- enable aileron servo if any heading mode is locked -->
        <not>
          <property>/autopilot/locks/passive-mode</property>
        </not>
        <not-equals>
          <property>/autopilot/locks/heading</property>
          <value/>
        </not-equals>
      </condition>
    </enable>
    <input>/autopilot/internal/aileron-command</input>
    <output>/controls/flight/aileron</output>
    <type>noise-spike</type>
    <max-rate-of-change>0.1</max-rate-of-change>
  </filter>

  <filter>
    <name>SERVO-DRIVER:elevator</name>
    <debug>false</debug>
    <feedback-if-disabled>true</feedback-if-disabled>
    <enable>
      <condition>
        <!-- enable aileron servo if any altitude mode is locked -->
        <not>
          <property>/autopilot/locks/passive-mode</property>
        </not>
        <not-equals>
          <property>/autopilot/locks/altitude</property>
          <value/>
        </not-equals>
      </condition>
    </enable>
    <input>/autopilot/internal/elevator-command</input>
    <output>/controls/flight/elevator-trim</output>
    <type>noise-spike</type>
    <max-rate-of-change>0.1</max-rate-of-change>
  </filter>

  <filter>
    <name>SERVO-DRIVER:rudder</name>
    <debug>false</debug>
    <feedback-if-disabled>true</feedback-if-disabled>
    <enable>
      <condition>
        <property>/instrumentation/autopilot/yaw-damper</property>
      </condition>
    </enable>
    <input>/autopilot/internal/rudder-command</input>
    <output>/controls/flight/rudder-trim</output>
    <type>noise-spike</type>
    <max-rate-of-change>0.1</max-rate-of-change>
  </filter>

  <!-- ========================================================================== -->
  <!-- Other filters, not related to the autopilot                                -->
  <!-- ========================================================================== -->

  <!-- ========================================================================== -->
  <!-- Provide a relative bearing property for the RMI -->
  <!-- ========================================================================== -->
  <pi-simple-controller>
    <name>OTHER:NAV1 relative bearing</name>
    <debug>false</debug>
    <enable>
      <condition>
        <property>/instrumentation/nav[0]/data-is-valid</property>
      </condition>
    </enable>
    <input>/orientation/heading-magnetic-deg</input>
    <reference>/instrumentation/nav[0]/radials/reciprocal-radial-deg</reference>
    <output>/instrumentation/nav[0]/relative-bearing-deg</output>
    <config>
      <Kp>1.0</Kp>
    </config>
  </pi-simple-controller>

  <pi-simple-controller>
    <name>OTHER:NAV2 relative bearing</name>
    <debug>false</debug>
    <enable>
      <condition>
        <property>/instrumentation/nav[1]/data-is-valid</property>
      </condition>
    </enable>
    <input>/orientation/heading-magnetic-deg</input>
    <reference>/instrumentation/nav[1]/radials/reciprocal-radial-deg</reference>
    <output>/instrumentation/nav[1]/relative-bearing-deg</output>
    <config>
      <Kp>1.0</Kp>
    </config>
  </pi-simple-controller>

</PropertyList>
