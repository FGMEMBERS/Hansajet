<?xml version="1.0"?>
 
<PropertyList>

  <!-- ========================================================================== -->
  <!-- ========================================================================== -->
  <!-- ========================================================================== -->
  <!-- Flight Director Computer -->
  <!-- ========================================================================== -->
  <!-- provide the input property for the cdi deflection and normlize to [-1..+1] -->
  <!-- 
       use this input if:
       mode = FI or
       captured and ( mode = BL or mode = VOR/LOC or mode = APP )
    -->
  <filter>
    <name>LOC deflection input normalizer</name>
    <debug>false</debug>
    <type>gain</type>
    <enable>
      <condition>
        <property>/autopilot/flightdirector/serviceable</property>
        <or>
          <equals>
            <property>/instrumentation/fd-controller/mode</property>
            <value>FI</value>
          </equals>
          <and>
        <equals>
          <property>/autopilot/flightdirector/localizer-captured</property>
          <value>1</value>
        </equals>
        <or>
          <equals>
            <property>/instrumentation/fd-controller/mode</property>
            <value>BL</value>
          </equals>
          <equals>
            <property>/instrumentation/fd-controller/mode</property>
            <value>VOR/LOC</value>
          </equals>
          <equals>
            <property>/instrumentation/fd-controller/mode</property>
            <value>APP</value>
          </equals>
        </or>
          </and>
        </or>
      </condition>
    </enable>
    <gain><value>-0.1</value></gain> <!-- input is in range [-10..+10] -->
    <input>/instrumentation/nav/heading-needle-deflection</input>
    <output>/autopilot/flightdirector/vertical-deflection-norm</output>
    <u_min>-1.0</u_min>
    <u_max>1.0</u_max>
  </filter>

  <!-- provide the input property for the heading bug error and normlize to [-1..+1] -->
  <!-- 
       use this input if:
       mode = FI or
       not captured and ( mode = BL or mode = VOR/LOC or mode = APP )
    -->
  <filter>
    <name>heading bug error input normalizer</name>
    <debug>false</debug>
    <type>gain</type>
    <enable>
      <condition>
        <property>/autopilot/flightdirector/serviceable</property>
        <or>
          <equals>
            <property>/instrumentation/fd-controller/mode</property>
            <value>FI</value>
          </equals>
          <and>
        <equals>
          <property>/autopilot/flightdirector/localizer-captured</property>
          <value>0</value>
        </equals>
        <or>
          <equals>
            <property>/instrumentation/fd-controller/mode</property>
            <value>BL</value>
          </equals>
          <equals>
            <property>/instrumentation/fd-controller/mode</property>
            <value>VOR/LOC</value>
          </equals>
          <equals>
            <property>/instrumentation/fd-controller/mode</property>
            <value>APP</value>
          </equals>
        </or>
          </and>
        </or>
      </condition>
    </enable>
    <gain><value>0.080</value></gain> <!-- 12.5deg is full deflection (half max. bank angle) -->
    <input>/autopilot/internal/heading-bug-error-deg</input>
    <output>/autopilot/flightdirector/vertical-deflection-norm</output>
    <u_min>-1.0</u_min>
    <u_max>1.0</u_max>
  </filter>

  <!-- 
     Flight Instruments Mode (FI)
     The vertical bar shows a steering command signal to fly to the selected
     heading. The heading is selected by setting the heading bug to the desired
     heading.
  -->

  <!-- 
     VOR/Localizer approach mode
     During VOR or localizer/ILS approaches, the vertical bar shows roll and steering
     commands to capture and track the selected course. The radial or localizer course
     is selected on HSI.
  -->

  <!-- 
   Flight Director Attitude Indicator 
   filter the input for the horizontal and vertical bar to provide a smooth 
   indication and generate output for two attitude indicators
   -->
  <filter>
    <name>horizontal bar deflection filter</name>
    <debug>false</debug>
    <type>exponential</type>
    <input>/autopilot/flightdirector/horizon-deflection-norm</input>
    <output>/instrumentation/attitude-indicator[0]/horizon-deflection-norm</output>
    <output>/instrumentation/attitude-indicator[1]/horizon-deflection-norm</output>
    <filter-time>0.3</filter-time>
  </filter>

  <filter>
    <name>vertical bar deflection filter</name>
    <debug>false</debug>
    <type>exponential</type>
    <input>/autopilot/flightdirector/vertical-deflection-norm</input>
    <output>/instrumentation/attitude-indicator[0]/vertical-deflection-norm</output>
    <output>/instrumentation/attitude-indicator[1]/vertical-deflection-norm</output>
    <filter-time>0.3</filter-time>
  </filter>

  <!-- Yaw Damper, automatic ball kicker -->
  <pid-controller>
    <name>yaw damper</name>
    <debug>false</debug>
    <enable>
      <condition>
        <property>/instrumentation/autopilot/yaw-damper</property>
      </condition>
    </enable>
    <input>
       <prop>/instrumentation/slip-skid-ball/indicated-slip-skid</prop>
    </input>
    <reference>
       <value>0.0</value>
    </reference>
    <output>
       <prop>/autopilot/internal/rudder-command</prop>
    </output>
    <config>
      <Kp>5</Kp>       <!-- proportional gain -->
      <beta>1.0</beta>     <!-- input value weighing factor -->
      <alpha>0.1</alpha>   <!-- low pass filter weighing factor -->
      <gamma>0.0</gamma>   <!-- input value weighing factor for -->
                           <!-- unfiltered derivative error -->
      <Ti>45.0</Ti>         <!-- integrator time -->
      <Td>0.0</Td>         <!-- derivator time -->
      <u_min>-0.15</u_min>  <!-- minimum output clamp -->
      <u_max>0.15</u_max>   <!-- maximum output clamp -->
    </config>
  </pid-controller>

  <!-- Altitude hold.  2 stage cascade controller. -->

  <!-- Stage #1 sets target rate of climb based on diff between current alt -->
  <!-- and target altitude. -->
  <pi-simple-controller>
    <name>Altitude Hold (Altimeter based) Stage 1</name>
    <debug>false</debug>
    <enable>
      <prop>/autopilot/locks/altitude</prop>
      <value>altitude-hold</value>
    </enable>
    <input>
      <prop>/position/altitude-ft</prop>
    </input>
    <reference>
      <prop>/autopilot/settings/target-altitude-ft</prop>
    </reference>
    <output>
      <prop>/autopilot/internal/target-climb-rate-fps</prop>
    </output>
    <config>
      <Kp>0.3</Kp>          <!-- proportional gain -->
      <Ki>0.0</Ki>          <!-- integral gain -->
      <u_min>-33.333</u_min> <!-- minimum output clamp -->
      <u_max>33.333</u_max>   <!-- maximum output clamp -->
    </config>
  </pi-simple-controller>

  <!-- Stage #2 drives the elevator-trim to achieve the desired climb rate. -->
  <pid-controller>
    <name>Altitude Hold (Altimeter based) Stage 2</name>
    <debug>false</debug>
    <enable>
      <prop>/autopilot/locks/altitude</prop>
      <value>altitude-hold</value>
    </enable>
    <input>
      <prop>/velocities/vertical-speed-fps</prop>
    </input>
    <reference>
      <prop>/autopilot/internal/target-climb-rate-fps</prop>
    </reference>
    <output>
      <prop>/autopilot/internal/elevator-command</prop>
    </output>
    <config>
      <Kp>-0.01</Kp>      <!-- proportional gain -->
      <beta>1.0</beta>    <!-- input value weighing factor -->
      <alpha>0.1</alpha>  <!-- low pass filter weighing factor -->
      <gamma>0.0</gamma>  <!-- input value weighing factor for -->
                          <!-- unfiltered derivative error -->
      <Ti>1000.0</Ti>       <!-- integrator time -->
      <Td>0.00001</Td>    <!-- derivator time -->
      <u_min>-1.0</u_min> <!-- minimum output clamp -->
      <u_max>1.0</u_max>  <!-- maximum output clamp -->
    </config>
  </pid-controller>

  <!-- Heading Bug Hold.  2 stage cascade controller. -->

  <!-- Stage #1 sets target roll based on diff between current heading -->
  <!-- and heading bug. -->
  <pid-controller>
    <name>Heading Bug Hold (DG based) Stage 1</name>
    <debug>false</debug>
    <enable>
      <condition>
        <equals>
          <property>/autopilot/locks/heading</property>
          <value>dg-heading-hold</value>
        </equals>
      </condition>
      <honor-passive>true</honor-passive>
    </enable>
    <input>
      <prop>/autopilot/internal/heading-bug-error-deg</prop>
    </input>
    <reference>
      <value>0.0</value>
    </reference>
    <output>
      <prop>/autopilot/internal/target-roll-deg</prop>
    </output>
    <config>
      <Kp>-2.0</Kp>        <!-- proportional gain -->
      <beta>1.0</beta>     <!-- input value weighing factor -->
      <alpha>0.1</alpha>   <!-- low pass filter weighing factor -->
      <gamma>0.1</gamma>   <!-- input value weighing factor for -->
                           <!-- unfiltered derivative error -->
      <Ti>10.0</Ti>        <!-- integrator time -->
      <Td>0.0001</Td>     <!-- derivator time -->
      <u_min>-25.0</u_min> <!-- minimum output clamp -->
      <u_max>25.0</u_max>  <!-- maximum output clamp -->
    </config>
  </pid-controller>

  <!-- Stage #2 drives the ailerons to achieve the desired roll deg. -->
  <pid-controller>
    <name>Heading Bug Hold (DG based) Stage 2</name>
    <debug>false</debug>
    <enable>
      <condition>
        <equals>
          <property>/autopilot/locks/heading</property>
          <value>dg-heading-hold</value>
        </equals>
      </condition>
    </enable>
    <input>
      <prop>/orientation/roll-deg</prop>
    </input>
    <reference>
      <prop>/autopilot/internal/target-roll-deg</prop>
    </reference>
    <output>
      <prop>/autopilot/internal/aileron-command</prop>
    </output>
    <config>
      <Kp>0.010</Kp>        <!-- proportional gain -->
      <beta>1.0</beta>    <!-- input value weighing factor -->
      <alpha>0.1</alpha>  <!-- low pass filter weighing factor -->
      <gamma>0.0</gamma>  <!-- input value weighing factor for -->
                          <!-- unfiltered derivative error -->
      <Ti>280.0</Ti>       <!-- integrator time -->
      <Td>0.00000</Td>    <!-- derivator time -->
      <u_min>-1.0</u_min> <!-- minimum output clamp -->
      <u_max>1.0</u_max>  <!-- maximum output clamp -->
    </config>
  </pid-controller>

  <!-- Wing leveler --> 
  <pid-controller>
    <name>Wing Leveler</name>
    <debug>false</debug>
    <enable>
      <condition>
        <equals>
          <property>/autopilot/locks/heading</property>
          <value>wing-leveler</value>
        </equals>
      </condition>
    </enable>
    <input>
      <prop>/orientation/yaw-rate-degps</prop>
    </input>
    <reference>
      <prop>/autopilot/settings/target-turn-rate-degps</prop>
    </reference>
    <output>
      <prop>/autopilot/internal/aileron-command</prop>
    </output>
    <config>
      <Kp>0.08</Kp>        <!-- proportional gain -->
      <beta>1.0</beta>    <!-- input value weighing factor -->
      <alpha>0.1</alpha>  <!-- low pass filter weighing factor -->
      <gamma>0.0</gamma>  <!-- input value weighing factor for -->
                          <!-- unfiltered derivative error -->
      <Ti>5.0</Ti>       <!-- integrator time -->
      <Td>0.00000</Td>    <!-- derivator time -->
      <u_min>-1.0</u_min> <!-- minimum output clamp -->
      <u_max>1.0</u_max>  <!-- maximum output clamp -->
    </config>
  </pid-controller>

  <filter>
    <name>aileron command filter</name>
    <debug>false</debug>
    <enable>
      <condition>
        <not-equals>
          <property>/autopilot/locks/heading</property>
          <value></value>
        </not-equals>
      </condition>
    </enable>
    <type>exponential</type>
    <input>/autopilot/internal/aileron-command</input>
    <output>/controls/flight/aileron</output>
    <filter-time>0.5</filter-time>
  </filter>

  <filter>
    <name>elevator command filter</name>
    <debug>false</debug>
    <enable>
      <condition>
        <not-equals>
          <property>/autopilot/locks/altitude</property>
          <value></value>
        </not-equals>
      </condition>
    </enable>
    <type>exponential</type>
    <input>/autopilot/internal/elevator-command</input>
    <output>/controls/flight/elevator-trim</output>
    <filter-time>0.5</filter-time>
  </filter>

  <filter>
    <name>rudder command filter</name>
    <debug>false</debug>
    <enable>
      <condition>
        <property>/instrumentation/autopilot/yaw-damper</property>
      </condition>
    </enable>
    <type>exponential</type>
    <input>/autopilot/internal/rudder-command</input>
    <output>/controls/flight/rudder-trim</output>
    <filter-time>0.5</filter-time>
  </filter>

  <!-- ========================================================================== -->
  <!-- Provide a relative bearing property for the RMI -->
  <!-- ========================================================================== -->
  <pi-simple-controller>
    <name>nav1 relative bearing</name>
    <debug>false</debug>
    <enable>
      <condition>
        <property>/instrumentation/nav[0]/data-is-valid</property>
      </condition>
    </enable>
    <input>
      <prop>/orientation/heading-magnetic-deg</prop>
    </input>
    <reference>
      <prop>/instrumentation/nav[0]/radials/reciprocal-radial-deg</prop>
    </reference>
    <output>
      <prop>/instrumentation/nav[0]/relative-bearing-deg</prop>
    </output>
    <config>
      <Kp>1.0</Kp>          <!-- proportional gain -->
      <Ki>0.0</Ki>          <!-- integral gain -->
    </config>
  </pi-simple-controller>

  <pi-simple-controller>
    <name>nav1 relative bearing</name>
    <debug>false</debug>
    <enable>
      <condition>
        <property>/instrumentation/nav[1]/data-is-valid</property>
      </condition>
    </enable>
    <input>
      <prop>/orientation/heading-magnetic-deg</prop>
    </input>
    <reference>
      <prop>/instrumentation/nav[1]/radials/reciprocal-radial-deg</prop>
    </reference>
    <output>
      <prop>/instrumentation/nav[1]/relative-bearing-deg</prop>
    </output>
    <config>
      <Kp>1.0</Kp>          <!-- proportional gain -->
      <Ki>0.0</Ki>          <!-- integral gain -->
    </config>
  </pi-simple-controller>

</PropertyList>
