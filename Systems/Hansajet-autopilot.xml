<?xml version="1.0"?>

<PropertyList xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../Docs/XMLSchema/autopilot.xsd">
  <!-- ========================================================================== -->
  <!-- 
    HFB 320 Hansa Jet Flight Director/Autopilot digital filter configuration
    
    Based on the only document found on the net for a Sperry Flight Director: 
    NTSB Aircraft Accident Report NTSB-AAR-74-3 (AAR74-03.pdf)
    
    If you have a better document describing the autopilot/flightdirector, please contact the author
    Torsten Dreyer - Torsten (at) t3r (dot) de
  -->
  <!-- ========================================================================== -->
  <!-- 
    Flight Director Modes
    ============
    SB    Standby   
    No indication, vertical and horizontal bars are moved out of sight
    
    BL   Blue Left
    No pitch/altitude indication, horziontal bar moved out of sight.
    Vertical bar shows course correction commands
    Used for backcourse ILS approaches
    
    FI    Flight Instruments
    Vertical bar shows roll command to the heading of the heading bug
    Horziontal bar shows pitch command if altitude-hold is engaged
        
    VOR/LOC
    Vertical and Horizontal bars show FI mode commands if outside "reception cone"
    And course correction commands uppon reception of valid VOR/LOC/GS signals.
    Valid VOR/LOC signal is deflection less than half left/half right
    Valid GS signal is: approaching from below and less than two dots below
    
    APP
    Show raw data course correction commands
    
    GA    Go Around
    Horziontal Bar shows commands fixed pitch up, Vertical Bar commands wings level 
    
    
    Autopilot Modes
    ==========
    Engage
    Off    Servos disconnected, flightdirector indication only only
    On    Servos connected
    
    Altitude Hold
    Off     No pitch/altitude processing
    On     Follow pitch command bar (horziontal bar) if signal is valid by adjusting pitch-trim
    
    Mach Hold
    Off     No throttle/speed processing
    On     Maintain indicated mach as of the time of engagement of Mach Hold
    
    Head
    Hold    Maintain heading of the heading bug
    NAV    keep CDI of HSI centered
    (LEFT)  perform TURN operation (see Turn)
    
    Turn
    Left    perform standad rate (4min) turn to the left
    Off     perform wing-level
    Right  perform standard rate (4min) turn to the right
    
  -->
  <!-- ========================================================================== -->
  <!-- provide the input property for the cdi deflection and normlize to [-1..+1] -->
  <!-- 
       use this input if:
       mode = FI or
       captured and ( mode = BL or mode = VOR/LOC or mode = APP )
    -->
  <filter>
    <name>LOC deflection input normalizer</name>
    <debug>false</debug>
    <type>gain</type>
    <enable>
      <condition>
        <or>
          <equals>
            <property>/autopilot/flightdirector/mode</property>
            <value>FI</value>
          </equals>
          <and>
            <equals>
              <property>/autopilot/flightdirector/localizer-captured</property>
              <value>1</value>
            </equals>
            <or>
              <equals>
                <property>/autopilot/flightdirector/mode</property>
                <value>BL</value>
              </equals>
              <equals>
                <property>/autopilot/flightdirector/mode</property>
                <value>VOR/LOC</value>
              </equals>
              <equals>
                <property>/autopilot/flightdirector/mode</property>
                <value>APP</value>
              </equals>
            </or>
          </and>
        </or>
      </condition>
    </enable>
    <gain>0.1</gain>
    <!-- input is in range [-10..+10] -->
    <input>/instrumentation/nav/heading-needle-deflection</input>
    <output>/autopilot/flightdirector/vertical-deflection-norm</output>
    <u_min>-1.0</u_min>
    <u_max>1.0</u_max>
  </filter>

  <!-- provide the input property for the heading bug error and normlize to [-1..+1] -->
  <!-- 
       use this input if:
       mode = FI or
       not captured and ( mode = BL or mode = VOR/LOC or mode = APP )
    -->
  <filter>
    <name>heading bug error input normalizer</name>
    <debug>false</debug>
    <type>gain</type>
    <enable>
      <condition>
        <or>
          <equals>
            <property>/autopilot/flightdirector/mode</property>
            <value>FI</value>
          </equals>
          <and>
            <equals>
              <property>/autopilot/flightdirector/localizer-captured</property>
              <value>0</value>
            </equals>
            <or>
              <equals>
                <property>/autopilot/flightdirector/mode</property>
                <value>BL</value>
              </equals>
              <equals>
                <property>/autopilot/flightdirector/mode</property>
                <value>VOR/LOC</value>
              </equals>
              <equals>
                <property>/autopilot/flightdirector/mode</property>
                <value>APP</value>
              </equals>
            </or>
          </and>
        </or>
      </condition>
    </enable>
    <gain>0.080</gain>
    <!-- 12.5deg is full deflection (half max. bank angle) -->
    <input>/autopilot/internal/heading-bug-error-deg</input>
    <output>/autopilot/flightdirector/vertical-deflection-norm</output>
    <u_min>-1.0</u_min>
    <u_max>1.0</u_max>
  </filter>

  <!-- ===================================================== -->
  <filter>
    <name>roll filter</name>
    <debug>false</debug>
    <type>double-exponential</type>
    <filter-time>0.1</filter-time>
    <input>/orientation/roll-deg</input>
    <output>/autopilot/internal/roll-deg</output>
  </filter>

  <!-- ========= go around, pitch up, wings level  ========= -->
  <pi-simple-controller>
    <name>Pitch G/A Filter</name>
    <debug>false</debug>
    <enable>
      <prop>/autopilot/flightdirector/mode</prop>
      <value>G/A</value>
    </enable>
    <input>
      <prop>/orientation/pitch-deg</prop>
    </input>
    <reference>
      <value>10</value>
    </reference>
    <output>
      <prop>/autopilot/flightdirector/horizon-deflection-norm</prop>
    </output>
    <config>
      <Kp>0.033</Kp>
      <!-- proportional gain -->
      <Ki>0.0</Ki>
      <!-- integral gain -->
      <u_min>-1.0</u_min>
      <u_max>1.0</u_max>
    </config>
  </pi-simple-controller>

  <pi-simple-controller>
    <name>Roll G/A Filter</name>
    <debug>false</debug>
    <enable>
      <prop>/autopilot/flightdirector/mode</prop>
      <value>G/A</value>
    </enable>
    <input>
      <prop>/autopilot/internal/roll-deg</prop>
    </input>
    <reference>
      <value>0</value>
    </reference>
    <output>
      <prop>/autopilot/flightdirector/vertical-deflection-norm</prop>
    </output>
    <config>
      <Kp>0.08</Kp>
      <!-- proportional gain -->
      <Ki>0.0</Ki>
      <!-- integral gain -->
      <u_min>-1.0</u_min>
      <u_max>1.0</u_max>
    </config>
  </pi-simple-controller>
  <!-- =========================================== -->

  <!-- Altitude hold for the FlightDirector ====== -->
  <pi-simple-controller>
    <name>Pitch Altitude Hold Filter</name>
    <debug>false</debug>
    <enable>
      <condition>
        <property>/autopilot/flightdirector/altitude-hold</property>
        <equals>
          <property>/autopilot/flightdirector/mode</property>
          <value>FI</value>
        </equals>
      </condition>
    </enable>
    <input>
      <prop>/instrumentation/altimeter[0]/pressure-alt-ft</prop>
    </input>
    <reference>
      <prop>/autopilot/settings/target-altitude-ft</prop>
    </reference>
    <output>
      <prop>/autopilot/flightdirector/horizon-deflection-norm</prop>
    </output>
    <config>
      <Kp>0.002</Kp>
      <!-- proportional gain, 500ft for full deflection -->
      <Ki>0.0</Ki>
      <!-- integral gain -->
      <u_min>-1.0</u_min>
      <u_max>1.0</u_max>
    </config>
  </pi-simple-controller>
  <!-- =========================================== -->

  <!-- low pass output filter for the horizontal bar -->
  <filter>
    <name>horizontal bar deflection filter</name>
    <debug>false</debug>
    <type>exponential</type>
    <input>/autopilot/flightdirector/horizon-deflection-norm</input>
    <output>/instrumentation/attitude-indicator[0]/horizon-deflection-norm</output>
    <output>/instrumentation/attitude-indicator[1]/horizon-deflection-norm</output>
    <filter-time>0.3</filter-time>
  </filter>
  <!-- =========================================== -->

  <!-- low pass output filter for the vertical bar -->
  <filter>
    <name>vertical bar deflection filter</name>
    <debug>false</debug>
    <type>exponential</type>
    <input>/autopilot/flightdirector/vertical-deflection-norm</input>
    <output>/instrumentation/attitude-indicator[0]/vertical-deflection-norm</output>
    <output>/instrumentation/attitude-indicator[1]/vertical-deflection-norm</output>
    <filter-time>0.3</filter-time>
  </filter>
  <!-- =========================================== -->

  <!-- 
    Two stage heading hold based on heading bug of HSI
    -->
  <pi-simple-controller>
    <name>Heading Hold Stage 1</name>
    <enable>
      <condition>
        <equals>
          <property>/autopilot/locks/heading</property>
          <value>dg-heading-hold</value>
        </equals>
      </condition>
    </enable>
    <debug>false</debug>
    <input>
      <prop>/autopilot/internal/heading-bug-error-deg</prop>
    </input>
    <reference>
      <value>0</value>
    </reference>
    <output>
      <prop>/autopilot/internal/target-roll-deg</prop>
    </output>
    <config>
      <Kp>-2.0</Kp>
      <!--  roll out at half bank angle -->
      <Ki>0.0</Ki>
      <!-- just scale the value, stage 2 integrates -->
      <u_min>-25.0</u_min>
      <!-- max. bank angle is 25deg -->
      <u_max>25.0</u_max>
    </config>
  </pi-simple-controller>

  <pid-controller>
    <name>AP wings level/turn</name>
    <debug>false</debug>
    <enable>
      <condition>
        <equals>
          <property>/autopilot/locks/heading</property>
          <value>wing-leveler</value>
        </equals>
      </condition>
    </enable>
    <input>
      <prop>/orientation/yaw-rate-degps</prop>
    </input>
    <reference>
      <prop>/autopilot/settings/target-turn-rate-degps</prop>
    </reference>
    <output>
      <prop>/autopilot/internal/target-roll-deg</prop>
    </output>
    <config>
      <Kp>2.0</Kp>
      <beta>1.0</beta>
      <alpha>0.1</alpha>
      <gamma>0.0</gamma>
      <Ti>1.0</Ti>
      <Td>0.00000</Td>
      <u_min>-25.0</u_min>
      <u_max>25.0</u_max>
    </config>
  </pid-controller>


  <!-- Two stage altitude hold based on Flight Director
       Horizontal bar deflection -->
  <pi-simple-controller>
    <name>Altitude Hold (Altitude based) Stage 1</name>
    <debug>false</debug>
    <input>
      <prop>/autopilot/flightdirector/horizon-deflection-norm</prop>
    </input>
    <reference>0.0</reference>
    <output>
      <prop>/autopilot/internal/target-climb-rate-fps</prop>
    </output>
    <config>
      <Kp>-33.333</Kp>
      <Ki>0.0</Ki>
    </config>
  </pi-simple-controller>

  <pid-controller>
    <name>Altitude Hold (Altitude based) Stage 2</name>
    <debug>false</debug>
    <enable>
      <prop>/autopilot/locks/altitude</prop>
      <value>altitude-hold</value>
    </enable>
    <input>
      <prop>/velocities/vertical-speed-fps</prop>
    </input>
    <reference>
      <prop>/autopilot/internal/target-climb-rate-fps</prop>
    </reference>
    <output>
      <prop>/autopilot/internal/elevator-command</prop>
    </output>
    <config>
      <Kp>-0.002</Kp>
      <beta>1.0</beta>
      <alpha>0.1</alpha>
      <gamma>0.0</gamma>
      <Ti>1000.0</Ti>
      <Td>0.00001</Td>
      <u_min>-1.0</u_min>
      <u_max>1.0</u_max>
    </config>
  </pid-controller>

  <!-- Yaw Damper, automatic ball kicker -->
  <pid-controller>
    <name>yaw damper</name>
    <debug>false</debug>
    <enable>
      <condition>
        <property>/instrumentation/autopilot/yaw-damper</property>
      </condition>
    </enable>
    <input>
      <prop>/instrumentation/slip-skid-ball/indicated-slip-skid</prop>
    </input>
    <reference>
      <value>0.0</value>
    </reference>
    <output>
      <prop>/autopilot/internal/rudder-command</prop>
    </output>
    <config>
      <Kp>5</Kp>
      <!-- proportional gain -->
      <beta>1.0</beta>
      <!-- input value weighing factor -->
      <alpha>0.1</alpha>
      <!-- low pass filter weighing factor -->
      <gamma>0.0</gamma>
      <!-- input value weighing factor for -->
      <!-- unfiltered derivative error -->
      <Ti>45.0</Ti>
      <!-- integrator time -->
      <Td>0.0</Td>
      <!-- derivator time -->
      <u_min>-0.15</u_min>
      <!-- minimum output clamp -->
      <u_max>0.15</u_max>
      <!-- maximum output clamp -->
    </config>
  </pid-controller>


  <!-- Compute aileron deflection based on roll command -->
  <pi-simple-controller>
    <name>Roll/Aileron Computer</name>
    <enable>
      <condition>
        <not-equals>
          <property>/autopilot/locks/heading</property>
          <value/>
        </not-equals>
      </condition>
    </enable>
    <debug>false</debug>
    <input>
      <prop>/autopilot/internal/roll-deg</prop>
    </input>
    <reference>
      <prop>/autopilot/internal/target-roll-deg</prop>
    </reference>
    <output>
      <prop>/autopilot/internal/aileron-command</prop>
    </output>
    <config>
      <Kp>0.003</Kp>
      <alpha>0.1</alpha>
      <beta>1.0</beta>
      <gamma>0.0</gamma>
      <Ti>10000.0</Ti>
      <Td>0.0000</Td>
      <u_min>-1.0</u_min>
      <u_max>1.0</u_max>
    </config>
  </pi-simple-controller>

  <!-- 
    Output filter for the servos, Pass output commands thru a noise spike filter
    to avoid fast control inputs and simulate slow movement of the servos. 
    Disable output if a/p is in passive-mode
      -->
  <filter>
    <name>aileron command filter</name>
    <debug>false</debug>
    <enable>
      <condition>
        <!-- enable aileron servo if autopilot is engaged and any heading mode is locked -->
        <not>
          <property>/autopilot/locks/passive-mode</property>
        </not>
        <not-equals>
          <property>/autopilot/locks/heading</property>
          <value/>
        </not-equals>
      </condition>
    </enable>
    <input>/autopilot/internal/aileron-command</input>
    <output>/controls/flight/aileron</output>
    <type>noise-spike</type>
    <max-rate-of-change>0.1</max-rate-of-change>
  </filter>

  <filter>
    <name>elevator command filter</name>
    <debug>false</debug>
    <enable>
      <condition>
        <!-- enable aileron servo if autopilot is engaged and any altitude mode is locked -->
        <not>
          <property>/autopilot/locks/passive-mode</property>
        </not>
        <not-equals>
          <property>/autopilot/locks/altitude</property>
          <value/>
        </not-equals>
      </condition>
    </enable>
    <input>/autopilot/internal/elevator-command</input>
    <output>/controls/flight/elevator-trim</output>
    <type>noise-spike</type>
    <max-rate-of-change>0.1</max-rate-of-change>
  </filter>

  <filter>
    <name>rudder command filter</name>
    <debug>false</debug>
    <enable>
      <condition>
        <property>/instrumentation/autopilot/yaw-damper</property>
      </condition>
    </enable>
    <input>/autopilot/internal/rudder-command</input>
    <output>/controls/flight/rudder-trim</output>
    <type>noise-spike</type>
    <max-rate-of-change>0.1</max-rate-of-change>
  </filter>

  <!-- ========================================================================== -->
  <!-- Other filters, not related to the autopilot                                -->
  <!-- ========================================================================== -->
  <!-- ========================================================================== -->
  <!-- Provide a relative bearing property for the RMI -->
  <!-- ========================================================================== -->
  <pi-simple-controller>
    <name>nav1 relative bearing</name>
    <debug>false</debug>
    <enable>
      <condition>
        <property>/instrumentation/nav[0]/data-is-valid</property>
      </condition>
    </enable>
    <input>
      <prop>/orientation/heading-magnetic-deg</prop>
    </input>
    <reference>
      <prop>/instrumentation/nav[0]/radials/reciprocal-radial-deg</prop>
    </reference>
    <output>
      <prop>/instrumentation/nav[0]/relative-bearing-deg</prop>
    </output>
    <config>
      <Kp>1.0</Kp>
      <!-- proportional gain -->
      <Ki>0.0</Ki>
      <!-- integral gain -->
    </config>
  </pi-simple-controller>

  <pi-simple-controller>
    <name>nav1 relative bearing</name>
    <debug>false</debug>
    <enable>
      <condition>
        <property>/instrumentation/nav[1]/data-is-valid</property>
      </condition>
    </enable>
    <input>
      <prop>/orientation/heading-magnetic-deg</prop>
    </input>
    <reference>
      <prop>/instrumentation/nav[1]/radials/reciprocal-radial-deg</prop>
    </reference>
    <output>
      <prop>/instrumentation/nav[1]/relative-bearing-deg</prop>
    </output>
    <config>
      <Kp>1.0</Kp>
      <!-- proportional gain -->
      <Ki>0.0</Ki>
      <!-- integral gain -->
    </config>
  </pi-simple-controller>

</PropertyList>
